{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap","webpack:///./src/dom.js","webpack:///./src/outil.js","webpack:///./src/md/parser.js","webpack:///./src/md/render.js","webpack:///./src/md/index.js","webpack:///./src/boot.js","webpack:///./src/valid.js","webpack:///./src/pos.js","webpack:///./src/brush.js","webpack:///./src/util.js","webpack:///./src/side.js","webpack:///./src/board.js","webpack:///./src/situation.js","webpack:///./src/move.js","webpack:///./src/actor.js","webpack:///./src/san.js","webpack:///./src/parser.js","webpack:///./src/rendermodel.js","webpack:///./src/svg.js","webpack:///./src/render.js","webpack:///./src/main.js"],"names":["root","factory","exports","module","define","amd","a","i","window","installedModules","__webpack_require__","moduleId","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","tag","nameklass","children","fStyle","klass","split","el","document","createElement","forEach","_","classList","add","appendChild","append","__webpack_exports__","div","textNode","updateChildren","fTranslateAbs","fAddClass","fAttribute","fListen","fHide","fShow","content","createTextNode","fupdate","firstChild","nextSibling","pos","style","transform","attributes","keys","setAttribute","event","f","addEventListener","contains","remove","objCopy","obj","o2","partition","list","b","push","objMap","res","u","objForeach","objFilter","groupToMap","item","Paragraph","Heading","Ply","Code","Text","parseParagraphFull","para","codeBeginRegex","codeEndRegex","cur","acc","match","type","join","length","parseParagraph","map","code","substring","variation","base","line","parseCode","parseMdFull","md","headingRegex","plyRegex","paragraph","lines","parseMd","updatePreview","model","$preview","toRemove","$_","removeChild","tags","createPTag","data-ply","createPly","dataGame","attribute","data-line","createParagraph","require","main","app","toValid","_invalid","valid","invalid","Validation","this","makeInvalid","makeValid","_valid","flatMap","fvalid","finvalid","validation","fold","check","ftest","checkOr","ftest1","ftest2","getOrElse","copy","copyMap","FileKlass","index","char","String","fromCharCode","RankKlass","File","A","B","C","D","E","F","G","H","of","Rank","PosKlass","file","rank","hore","stop","dir","righte","right","lefte","left","down","Pos","at","downLeft","downRight","up","upLeft","upRight","apply","atfr","x","y","allIndexes","all","allKeys","fromKey","A1","B1","C1","Pawn","forsyth","roleString","Knight","dirs","Bishop","Rook","color","role","Queen","flat","King","Role","allByRole","allByForsyth","brush","opacity","lineWidth","files","ranks","Array","concat","pos2key","key2pos","k","charCodeAt","black","white","asWhite","flip","colors","w","roles","q","readShapes","shapes","s1","s2","orig","dest","readFen","fen","sPieces","sTurn","sCastles","sExtra","pieces","sRow","row","col","toLowerCase","parseInt","readMoves","moves","blackMoveRegex","whiteMoveRegex","oneMove","ply","_moves","next","moveMatch","readPly","sPly","writeFen","spaces","piece","toUpperCase","fPosToTranslateAbs","bounds","xFactor","width","yFactor","height","posToTranslateBase","KingSide","castledKingFile","castledRookFile","tripToRook","kingPos","board","QueenSide","Board","take","_pieces","place","to","move","from","taking","actorsOf","values","actors","kingPosOf","find","actorAt","[object Object]","Actor","Situation","Move","situationBefore","after","capture","promotion","castle","enpassant","before","situationAfter","util","pseudoValidMoves","pawnDir","fwd","horizontal","p2","m2","forward","shortRange","longRange","castleOn","side","tr","rookPos","newKingPos","newRookPos","king","rook","pawnDirOf","addAll","extra","Std","san","compare","situation","Castle","actor","parseLine","err","prom","mate","parseSan","renderLineModel","vLine","plyMove","RenderLineModel","plyStrWhite","plyStrBlack","initial","fromFen","svg","createElementNS","renderShape","shape","orient","arrowMargin","pos2px","dx","dy","angle","Math","atan2","xo","cos","yo","sin","setAttributes","stroke","stroke-width","stroke-linecap","marker-end","x1","y1","x2","y2","renderArrow","circleWidth","radius","fill","cx","cy","renderCircle","renderMarker","marker","id","markerWidth","markerHeight","refX","refY","attrs","render_ranks","render_files","render_key2pos","render_svg","render_renderMarker","SVG","dom","play","ctx","game","lastMove","error","els","unlisten","history","init","data","moveFor","colorFor","getBoundingClientRect","syncVisible","isInViewport","top","bottom","innerHeight","innerWidth","render","wrapper","wrap","fPosToTranslate","mdKey","_svg","renderFen","element","fResize","observer","ResizeObserver","observe","unobserve","listenResize","elBoard","updateBounds","updateSvg","MoveLine","sGame","dataset","sLine","sColor","_game","fHover","show","fOut","hide","depth","lineDepthFor","onHover","mwhite","mblack","onHoverWhite","onHoverBlack","fAttributeWhite","title","data-err","fAttributeBlack","renderLine","mw","mb","History","linesByGame","allGames","movesByGame","lineDepthByGame","colorByGame","console","warn","oMove","situationFor","playMoves","findColorByGameHelper","step","curr","variationLines","variationMoves","sort","playVariationsHelper","v","makePlys","makeMoveLines","Play","querySelectorAll","plys","hoverEl","hoverPly","visiblePly","filter","findVisiblePly","listen","onEndScroll","isScrolling","clearTimeout","setTimeout","listenEndScroll","elN","vp","posToTranslate","pageXOffset","pageYOffset","clientWidth","offBounds","helBounds","options"],"mappings":"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","file":"bundle_umd.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse {\n\t\tvar a = factory();\n\t\tfor(var i in a) (typeof exports === 'object' ? exports : root)[i] = a[i];\n\t}\n})(window, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n","export function tag(nameklass, children = [], fStyle) {\n\n  let [name, ...klass] = nameklass.split('.');\n\n  let el = document.createElement(name);\n\n  klass.forEach(_ => {\n    el.classList.add(_);\n  });\n\n  if (children.forEach) {\n    children.forEach(_ => {\n      el.appendChild(_);\n    });\n  } else {\n    el.append(children);\n  }\n\n  if (fStyle) {\n    if (fStyle.forEach) {\n      fStyle.forEach(_ => _(el));\n    } else {\n      fStyle(el);\n    }\n  }\n\n  return el;\n}\n\nexport const div = (klass, children, fStyle) => tag('div' + klass, children, fStyle);\n\nexport const textNode = (content) => {\n  return document.createTextNode(content);\n};\n\nexport const updateChildren = (el, fupdate) => {\n  el = el.firstChild;\n\n  while (el) {\n    fupdate(el);\n    el = el.nextSibling;\n  }\n};\n\nexport const fTranslateAbs = (pos) => {\n  return el => {\n    el.style.transform = `translate(${pos[0]}px,${pos[1]}px)`;\n  };\n};\n\nexport const fAddClass = (klass) => {\n  return el => {\n    klass.split('.').forEach(_ => {\n      el.classList.add(_);\n    });\n  };\n};\n\nexport const fAttribute = attributes => {\n  return el => {\n    Object.keys(attributes).forEach(_ => {\n      if (attributes[_]) {\n        el.setAttribute(_, attributes[_]);\n      }\n    });\n    return el;\n  };\n};\n\nexport const fListen = (event, f) => {\n  return el => {\n    el.addEventListener(event, () => {\n      f(el);\n    });\n  };\n};\n\nexport const fHide = el => {\n  if (!el.classList.contains('hidden')) {\n    el.classList.add('hidden');\n  }\n};\n\nexport const fShow = el => {\n  if (el.classList.contains('hidden')) {\n    el.classList.remove('hidden');\n  }\n};\n","export function objCopy(obj) {\n  let o2 = {};\n\n  for (let key in obj) {\n    o2[key] = obj[key];\n  }\n  return o2;\n}\n\nexport function partition(list, f) {\n  let a = [], b = [];\n\n  list.forEach(_ => f(_) ? a.push(_) : b.push(_));\n\n  return [a, b];\n}\n\nexport function objMap(obj, f) {\n  let res = {};\n\n  Object.keys(obj).forEach(key => {\n    let u = f(key, obj[key]);\n    let _ = Object.keys(u)[0];\n    res[_] = u[_];\n  });\n\n  return res;\n}\n\nexport function objForeach(obj, f) {\n  Object.keys(obj).forEach(key => f(key, obj[key]));\n}\n\nexport function objFilter(obj, f) {\n  let res = {};\n\n  for (let key in obj) {\n    if (f(key, obj[key])) {\n      res[key] = obj[key];\n    }\n  }\n  return res;\n}\n\nexport function groupToMap(list, f) {\n  let res = {};\n\n  list.forEach(item => {\n    let u = f(item);\n    let _ = Object.keys(u)[0];\n    if (!res[_]) {\n      res[_] = [];\n    }\n\n    res[_].push(u[_]);\n  });\n  return res;\n}\n","export const Paragraph = 1,\nHeading = 2,\nPly = 3;\n\nexport const Code = 1,\nText = 2;\n\nexport function parseCode(code) {\n  const variationRegex = /^([a-zA-Z][^\\s]*) ([a-zA-Z][^\\s]*) (.*)/;\n  let match;\n\n  code = code.substring(1, code.length - 1);\n\n  if ((match = code.match(variationRegex))) {\n    let [_, variation, base, line] = match;\n    return { variation, base, line };\n  }\n  return { line: code };\n}\n\nexport function parseParagraph(para) {\n  const codeBeginRegex = /^</,\n        codeEndRegex = />$/;\n\n  let cur = Text,\n      acc = [];\n  let res = [];\n\n  para.split(' ').forEach(_ => {\n    let match;\n\n    if (cur === Text) {\n      if ((match = _.match(codeBeginRegex))) {\n        res.push({ type: Text, content: acc.join(' ') + ' ' });\n        cur = Code;\n        acc = [_];\n\n        if ((match = _.match(codeEndRegex))) {\n          res.push({ type: Code, content: acc.join(' ') });\n          cur = Text;\n          acc = [];\n        }\n      } else {\n        acc.push(_);\n      }\n    } else if (cur === Code) {\n      if ((match = _.match(codeEndRegex))) {\n        acc.push(_);\n        res.push({ type: Code, content: acc.join(' ') });\n        cur = Text;\n        acc = [];\n      } else {\n        acc.push(_);\n      }\n    }\n  });\n\n  if (acc.length > 0) {\n    res.push({ type: cur, content: acc.join(' ') });\n  }\n\n  return res;\n}\n\nexport function parseParagraphFull(para) {\n  return parseParagraph(para).map(_ => {\n    if (_.type === Code) {\n      _.content = parseCode(_.content);\n    }\n    return _;\n  });\n}\n\nexport function parseMdFull(md) {\n  return parseMd(md).map(_ => {\n    if (_.type === Paragraph) {\n      _.content = parseParagraphFull(_.content);\n    }\n    return _;\n  });\n}\n\nexport function parseMd(md) {\n  const headingRegex = /^#([^\\n]*)/;\n  const plyRegex = /^=([^\\n]*)/;\n\n  let paragraph = [];\n  let res = [];\n  let lines = md.split('\\n');\n  let pos = 0;\n\n  lines.forEach(line => {\n    if (line === \"\") {\n      if (paragraph.length) {\n        let content = paragraph.join('\\n');\n        res.push({ type: Paragraph, pos, content });\n        paragraph = [];\n        pos += content.length + 1;\n      }\n      pos += 1;\n      return;\n    }\n\n    let match;\n\n    if ((match = line.match(plyRegex))) {\n      let content = paragraph.join('\\n');\n      if (paragraph.length) {\n        res.push({ type: Paragraph, pos, content });\n        paragraph = [];\n        pos += content.length + 1;\n      }\n\n      content = match[1];\n      res.push({ type: Ply, pos, content });\n      pos += content.length + 2;\n    } else if ((match = line.match(headingRegex))) {\n      let content = paragraph.join('\\n');\n      if (paragraph.length) {\n        res.push({ type: Paragraph, pos, content });\n        paragraph = [];\n        pos += content.length + 1;\n      }\n\n      content = match[1];\n      res.push({ type: Heading, pos, content });\n      pos += content.length + 2;\n    } else {\n      paragraph.push(line);\n    }\n  });\n\n  if (paragraph.length) {\n    let content = paragraph.join('\\n');\n    res.push({ type: Paragraph, pos, content });\n    paragraph = [];\n    pos += content.length;\n  }\n\n  return res;\n\n}\n","import { fSeq, objMap, objForeach } from '../outil';\nimport { fAttribute, tag, textNode, fListen } from '../dom';\nimport { Code, Text, Ply, Paragraph, Heading } from './parser';\n\nexport function updatePreview(model, $preview) {\n\n  let toRemove = [];\n  let $_ = $preview.firstChild;\n  while ($_) {\n    toRemove.push($_);\n    $_ = $_.nextSibling;\n  }\n\n  for (let $_ of toRemove) $preview.removeChild($_);\n\n  let tags = model.map(({ type, content, pos }) => {\n    return {\n      pos,\n      $_: createPTag(type, content, pos)\n    };\n  });\n\n  tags.forEach(_ => {\n    $preview.appendChild(_.$_);\n  });\n\n  return tags;\n}\n\nfunction createParagraph(content) {\n  return tag(`p`, content.map(({ type, content }) => {\n    switch (type) {\n    case Code:\n      let dataGame = content.variation ? `${content.variation} ${content.base}` : null;\n      let attribute = { 'data-line': content.line };\n\n      if (dataGame) {\n        attribute['data-game'] = dataGame;\n      }\n      return tag('span', [], fAttribute(attribute));\n      break;\n    case Text:\n      return textNode(content);\n      break;\n    default:\n      return null;\n      break;\n    }\n  }));\n}\n\nfunction createPly(content) {\n  return tag('div', [], fAttribute({ 'data-ply': content }));\n}\n\nfunction createPTag(type, content) {\n  switch (type) {\n  case Ply:\n    return createPly(content);\n    break;\n  case Paragraph:\n    return createParagraph(content);\n    break;\n  case Heading:\n    return tag('h2', content);\n    break;\n  default:\n    return null;\n    break;\n  }\n}\n","export { parseMdFull } from './parser';\nexport { updatePreview } from './render';\n","require('./index.css');\nrequire('./notation.css');\nrequire('./ply.css');\nrequire('../assets/pixel.css');\n\nconst main = require('./main');\n\nmodule.exports = main.app;\nmodule.exports.md = require('./md');\n","export function toValid(value, _invalid) {\n  return value ? valid(value) :\n    invalid(_invalid);\n};\n\nexport function valid(value) {\n  return new Validation(null, value);\n};\n\nexport function invalid(invalid) {\n  return new Validation(invalid);\n};\n\nexport function group(fOs, _) {\n  let res = valid({});\n\n  fOs.forEach(fO => {\n    let res2;\n    if ((res2 = fO(_))) {\n      res = res.flatMap(acc => \n        res2.map(b => {\n          for (let key in b) {\n            acc[key] = b[key];\n          }\n          return acc;\n        })\n      );\n    }\n  });\n\n  return res;\n};\n\nexport function fOptional(property, fCheck) {\n  return _ => {\n    if (_[property]) {\n      return fCheck(_[property])\n        .map(_ => ({ [property]: _ }));\n    } else return null;\n  };\n};\n\nfunction Validation(invalid, valid) {\n  this.invalid = invalid;\n  this.valid = valid;\n\n  const makeInvalid = (_invalid) => {\n    valid = null;\n    invalid = _invalid;\n\n    this.invalid = invalid;\n    this.valid = valid;\n  };\n\n  const makeValid = (_valid) => {\n    valid = _valid;\n    invalid = null;\n\n    this.valid = valid;\n    this.invalid = invalid;\n  };\n\n  this.flatMap = (fvalid, finvalid = _ => validation.invalid(_)) => {\n    return this.valid ? fvalid(this.valid) : \n      finvalid(this.invalid);\n  };\n\n  this.fold = (fvalid, finvalid = _ => _) => {\n    return this.valid ? fvalid(this.valid) : \n      finvalid(this.invalid);\n  };\n\n\n  this.map = (fvalid) => {\n    if (this.valid) {\n      makeValid(fvalid(valid));\n    }\n    return this;\n  };\n\n  this.check = (ftest, _invalid) => {\n    if (this.valid && ftest(this.valid)) {\n      makeInvalid(_invalid);\n    }\n    return this;\n  };\n\n  this.checkOr = (ftest1, ftest2, _invalid) => {\n    if (this.valid && !(ftest1(this.valid)\n                        || ftest2(this.valid))) {\n      makeInvalid(_invalid);\n    }\n    return this;\n  };\n\n  this.getOrElse = (_) => {\n    return this.valid ? this.valid : _();\n  };\n\n  this.copy = () => {\n    return new Validation(invalid, valid);\n  };\n\n  this.copyMap = (fvalid) => {\n    return this.copy().map(fvalid);\n  };\n}\n","function FileKlass(index) {\n  this.index = index;\n  this.char = String.fromCharCode(97 + index);\n};\n\nfunction RankKlass(index) {\n  this.index = index;\n  this.char = String.fromCharCode(49 + index);\n};\n\nexport const File = {\n  A: new FileKlass(0),\n  B: new FileKlass(1),\n  C: new FileKlass(2),\n  D: new FileKlass(3),\n  E: new FileKlass(4),\n  F: new FileKlass(5),\n  G: new FileKlass(6),\n  H: new FileKlass(7),\n  of: pos => new FileKlass(pos.index & 0x7)\n};\n\n\n\nexport const Rank = {\n  of: pos => new RankKlass(pos.index >> 3)\n};\n\nfunction PosKlass(index) {\n\n  this.index = index;\n\n  let file = File.of(this);\n  let rank = Rank.of(this);\n\n  this.file = file;\n  this.rank = rank;\n  this.key = file.char + rank.char;\n\n  this.hore = (stop, dir) => {\n    let p = dir(this);\n    if (!p) {\n      return [];\n    }\n\n    return [p, ...stop(p) ? [] : p.hore(stop, dir)];\n  };\n  this.righte = stop => this.hore(stop, _ => _.right());\n  this.lefte = stop => this.hore(stop, _ => _.left());\n\n  this.down = () => Pos.at(file.index, rank.index - 1);\n  this.left = () => Pos.at(file.index - 1, rank.index);\n  this.downLeft = () => Pos.at(file.index - 1, rank.index - 1);\n  this.downRight = () => Pos.at(file.index + 1, rank.index - 1);\n  this.up = () => Pos.at(file.index, rank.index + 1);\n  this.right = () => Pos.at(file.index + 1, rank.index);\n  this.upLeft = () => Pos.at(file.index - 1, rank.index + 1);\n  this.upRight = () => Pos.at(file.index + 1, rank.index + 1);\n};\n\nexport const Pos = {\n  apply: index => new PosKlass(index),\n  atfr: (file, rank) => new PosKlass(file.index + 8 * rank.index),\n  at: (x, y) => {\n    if (0 <= x && x < 8 && 0 <= y && y < 8) return new PosKlass(x + 8 * y);\n    else return null;\n  }\n};\n\nconst allIndexes = [];\nfor (let i = 0; i < 64; i++) {\n  allIndexes.push(i);\n}\n\nPos.all = allIndexes.map(_ => new PosKlass(_)),\nPos.allKeys = {};\n\nPos.all.forEach(pos => Pos.allKeys[pos.key] = pos);\nPos.fromKey = _ => Pos.allKeys[_];\n\nPos.A1 = new PosKlass(0);\nPos.B1 = new PosKlass(1);\nPos.C1 = new PosKlass(2);\n\nexport const Pawn = {\n  forsyth: 'P',\n  roleString: 'pawn'\n};\n\nexport const Knight = {\n  forsyth: 'N',\n  roleString: 'knight',\n  dirs: [\n    _ => Pos.at(_.file.index - 1, _.rank.index + 2),\n    _ => Pos.at(_.file.index - 1, _.rank.index - 2),\n    _ => Pos.at(_.file.index + 1, _.rank.index + 2),\n    _ => Pos.at(_.file.index + 1, _.rank.index - 2),\n    _ => Pos.at(_.file.index - 2, _.rank.index + 1),\n    _ => Pos.at(_.file.index - 2, _.rank.index - 1),\n    _ => Pos.at(_.file.index + 2, _.rank.index + 1),\n    _ => Pos.at(_.file.index + 2, _.rank.index - 1),\n  ]\n};\n\nexport const Bishop = {\n  forsyth: 'B',\n  roleString: 'bishop',\n  dirs: [_ => _.upLeft(), _ => _.upRight(), _ => _.downLeft(), _ => _.downRight()]\n};\n\nexport const Rook = {\n  color(color) {\n    return {\n      role: 'rook',\n      color\n    };\n  },\n  forsyth: 'R',\n  roleString: 'rook',\n  dirs: [_ => _.up(), _ => _.down(), _ => _.left(), _ => _.right()]\n};\n\nexport const Queen = {\n  forsyth: 'Q',\n  roleString: 'queen',\n  dirs: [Rook.dirs, Bishop.dirs].flat()\n};\n\nexport const King = {\n  color(color) {\n    return {\n      role: 'king',\n      color\n    };\n  },\n  forsyth: 'K',\n  roleString: 'king',\n  dirs: Queen.dirs\n};\n\n\nexport const Role = {\n  all: [King, Queen, Bishop, Rook, Pawn, Knight]\n};\n\nRole.allByRole = {};\nRole.all.forEach(role => Role.allByRole[role.roleString] = role);\nRole.allByForsyth = {};\nRole.all.forEach(role => Role.allByForsyth[role.forsyth] = role);\n\nRole.forsyth = _ => Role.allByForsyth[_];\n","export const brush = {\n  key: 'g',\n  color: '#15781B',\n  opacity: 1,\n  lineWidth: 10,\n};\n","import { Role }  from './pos';\nimport { brush } from './brush';\n\nexport const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];\nexport const ranks = ['1', '2', '3', '4', '5', '6', '7', '8'];\n\nexport const allKeys = Array.prototype.concat(...files.map(c => ranks.map(r => c + r)));\n\nexport const pos2key = pos => allKeys[8 * pos[0] + pos[1]];\n\nexport const key2pos = k => [k.charCodeAt(0) - 97, k.charCodeAt(1) - 49];\n\nexport const black = 'black',\n      white = 'white';\n\nexport function asWhite(color) {\n  return color === white;\n}\n\nexport function flip(color) {\n  return color === white ? black : white;\n}\n\nlet colors = {\n  'w': white,\n  'b': black\n};\n\nlet roles = {\n  'k': 'king',\n  'q': 'queen',\n  'r': 'rook',\n  'b': 'bishop',\n  'n': 'knight',\n  'p': 'pawn'\n};\n\nexport function readShapes(shapes) {\n  if (!shapes) {\n    return [];\n  }\n  let sShapes = shapes.split(' ');\n  return sShapes.map(_ => {\n    let [s1,s2] = _.split('-');\n\n    return {\n      orig: (_ => _)(s1),\n      dest: (_ => _)(s2),\n      brush\n    };\n  });\n}\n\nexport function readFen(fen) {\n  let [sPieces, sTurn, sCastles, sExtra] = fen.split(' ');\n\n  let color = colors[sTurn];\n\n  let pieces = {};\n\n  sPieces.split('/').forEach((sRow, row) => {\n    row = 7 - row;\n\n    let col = 0;\n    for (let char of sRow) {\n      let role,\n          color;\n      if ((role = roles[char])) {\n        color = black;\n      } else if ((role = roles[char.toLowerCase()])) {\n        color = white;\n      }\n      if (color) {\n        pieces[pos2key([col, row])] = {\n          role,\n          color\n        };\n        col++;\n      } else {\n        col += parseInt(char);\n      }\n    }\n  });\n\n  return {\n    pieces,\n    color,\n  };\n}\n\nexport function readMoves(moves) {\n\n  const blackMoveRegex = /^(\\d*)\\.\\.\\.$/;\n  const whiteMoveRegex = /^(\\d*)\\.$/;\n\n  let oneMove,\n      ply,\n      _moves = [];\n\n  moves.split(' ').forEach(next => {\n\n    let match;\n\n    if ((match = next.match(blackMoveRegex))) {\n      ply = parseInt(match[0]) * 2;\n      oneMove = [null];\n    } else if ((match = next.match(whiteMoveRegex))) {\n      ply = parseInt(match[0]) * 2 - 1;\n      oneMove = [];\n    } else if ((match = moveMatch(next))) {\n      oneMove.push({\n        ply,\n        ...match\n      });\n      ply++;\n\n      if (oneMove.length === 2) {\n        _moves.push(oneMove);\n        oneMove = [];\n      }\n    }\n  });\n\n  if (oneMove.length === 1) {\n    _moves.push(oneMove);\n  }\n  \n  return {\n    moves: _moves\n  };\n}\n\nexport function readPly(sPly) {\n  return parseInt(sPly);\n}\n\nexport function writeFen({ pieces }) {\n\n  let sPieces = '';\n\n  for (let row = 7; row >= 0; row--) {\n    let spaces = 0;\n    for (let col = 0; col <= 7; col++) {\n      let key = pos2key([col, row]);\n      let piece;\n      if ((piece = pieces[key])) {\n        if (spaces > 0) {\n          sPieces += spaces;\n          spaces = 0;\n        }\n        let role = Role.allByRole[piece.role];\n        sPieces += piece.color === white ? role.forsyth.toUpperCase() : role.forsyth.toLowerCase();\n      } else {\n        spaces++;\n      }\n    }\n    if (spaces > 0) {\n      sPieces += spaces;\n    }\n    sPieces += '/';\n  }\n\n  return sPieces;\n}\n\nconst posToTranslateBase = (pos, asWhite, xFactor, yFactor) => [\n  (asWhite ? pos[0] : 7 - pos[0]) * xFactor,\n  (asWhite ? 7 - pos[1] : pos[1]) * yFactor\n];\n\nexport const fPosToTranslateAbs = bounds => {\n  const xFactor = bounds.width / 8,\n        yFactor = bounds.height / 8;\n\n  return (pos, asWhite) =>\n  posToTranslateBase(pos, asWhite, xFactor, yFactor);\n};\n","import { File } from './pos';\n\nexport const KingSide = {\n  name: 'king',\n  castledKingFile: File.G,\n  castledRookFile: File.F,\n  tripToRook: (kingPos, board) => \n  kingPos.righte(_ => board.pieces[_.key])\n};\n\nexport const QueenSide = {\n  name: 'queen',\n  castledKingFile: File.C,\n  castledRookFile: File.D,\n  tripToRook: (kingPos, board) =>\n  kingPos.lefte(_ => board.pieces[_.key])\n};\n\n","import { objCopy, objMap, partition } from './outil';\nimport * as util from './util';\nimport { Pos } from './pos';\nimport Actor from './actor';\n\nexport default function Board(pieces, color) {\n\n  this.take = pos => {\n    let _pieces = objCopy(pieces);\n\n    delete _pieces[pos.key];\n    return new Board(_pieces, color);\n  };\n\n  this.place = (piece, to) => {\n    let _pieces = objCopy(pieces);\n\n    _pieces[to.key] = piece;\n\n    return new Board(_pieces, color);\n  };\n\n  this.move = (from, to) => {\n    let _pieces = objCopy(pieces);\n\n    _pieces[to.key] = _pieces[from.key];\n    delete _pieces[from.key];\n\n    return new Board(_pieces, color);\n  };\n\n  this.taking = (from, to) => {\n    let _pieces = objCopy(pieces);\n\n    _pieces[to.key] = _pieces[from.key];\n    delete _pieces[from.key];\n\n    return new Board(_pieces, color);    \n  };\n\n  this.actorsOf = () => {\n    let [white, black] = \n        partition(\n          Object.values(this.actors),\n          _ => _.color === 'white');\n\n    return {\n      white,\n      black\n    };\n  };\n\n  let opponent = () => color === 'white' ? 'black' : 'white';\n\n  this.kingPosOf = (color) => {\n    let res = Object.keys(pieces)\n    .find(_ => {\n      let piece = pieces[_];\n      return piece.color === color &&\n        piece.role === 'king';\n    });\n    return Pos.fromKey(res);\n  };\n\n  this.actorAt = pos => this.actors[pos];\n\n  this.color = color;\n  this.pieces = pieces;\n\n  this.actors = objMap(pieces, (pos, piece) => ({\n    [pos]: new Actor(piece, Pos.fromKey(pos), this)\n  }));\n}\n\nBoard.initial = () =>\nBoard.fromFen('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');\n\nBoard.fromFen = (fen) => {\n  let { pieces, color } = util.readFen(fen);\n  return new Board(pieces, color);\n};\n","import Board from './board';\nimport Actor from './actor';\n\nexport default function Situation(board, color) {\n\n  this.board = board;\n  this.color = color;\n      \n  let actors = board.actorsOf(color);\n}\n\nSituation.apply = () =>\nnew Situation(Board.initial(), 'white');\n","import * as util from './util';\nimport Situation from './situation';\n\nexport default function Move({\n  piece,\n  orig,\n  dest,\n  situationBefore,\n  after,\n  capture,\n  promotion,\n  castle,\n  enpassant\n}) {\n\n  this.piece = piece;\n  this.orig = orig;\n  this.dest = dest;\n  \n  this.situationBefore = () => situationBefore;\n  this.after = () => after;\n  this.before = () => situationBefore.board;\n  this.situationAfter = () => \n  new Situation(finalizeAfter(), \n                util.flip(piece.color));\n\n  function finalizeAfter() {\n    return after;\n  };\n\n  \n\n}\n","import { Pos, \n         King,\n         Queen,\n         Bishop,\n         Knight,\n         Pawn,\n         Rook } from './pos';\n\nimport { KingSide, QueenSide } from './side';\n\nimport Situation from './situation';\nimport Move from './move';\n\nexport default function Actor(piece, pos, board) {\n  let color = piece.color;\n\n  this.color = color;\n  this.pos = pos;\n  this.pseudoValidMoves = pseudoValidMoves;\n\n  function pseudoValidMoves() {\n    let res = [];\n\n    switch (piece.role) {\n    case 'pawn':\n      let next = pawnDir()(pos);\n      let fwd = next;\n      function capture(horizontal) {\n        let p = horizontal(next);\n        if (!p) {\n          return null;\n        }\n\n        if (!board.pieces[p.key] ||\n            board.pieces[p.key].color === color) {\n          return null;\n        }\n        let b = board.taking(pos, p);\n\n        return move(p, b, { capture: p });\n      }\n      let p2 = pawnDir()(fwd);\n      let m2 = [];\n\n      if (p2) {\n        let b = board.move(pos, p2);\n        m2 = move(p2, b);\n      }\n\n      res.push([\n        fwd && forward(fwd) || [],\n        m2,\n        capture(_ => _.left()) || [],\n        capture(_ => _.right()) || [],\n      ].flat());\n      break;\n    case 'king':\n      res.push(shortRange(King.dirs));\n      res.push(castle());\n      break;\n    case 'knight':\n      res.push(shortRange(Knight.dirs));\n      break;\n    case 'bishop':\n      res.push(longRange(Bishop.dirs));\n      break;\n    case 'rook':\n      res.push(longRange(Rook.dirs));\n      break;\n    case 'queen':\n      res.push(longRange(Queen.dirs));\n      break;\n    }\n\n    return res.flatMap(_ =>\n      _\n    );\n  }\n\n  const castle = () => \n        castleOn(KingSide)\n        .concat(castleOn(QueenSide));\n  \n  this.castleOn = castleOn;\n\n  function castleOn(side) {\n    \n    let kingPos = board.kingPosOf(color);\n\n    if (!kingPos) {\n      return [];\n    }\n\n    let tr = side.tripToRook(kingPos, board);\n    let rookPos = tr[tr.length - 1];\n\n    let newKingPos = Pos.atfr(side.castledKingFile, kingPos.rank);\n    let newRookPos = Pos.atfr(side.castledRookFile, rookPos.rank);\n\n    let castle = {\n      king: { [kingPos.key]: newKingPos },\n      rook: { [rookPos.key]: newRookPos },\n      side: side.name\n    };\n\n    let b1 = board.take(kingPos),\n        b2 = b1.take(rookPos),\n        b3 = b2.place(King.color(color), newKingPos),\n        b4 = b3.place(Rook.color(color), newRookPos),\n        b5 = b4;    \n\n    return [move(kingPos, b5, { castle })];\n  }\n\n  function forward(p) {\n    let _ = board.move(pos, p);\n\n    if (_) {\n      return move(p, _);\n    }\n    return null;\n  }\n\n  function pawnDir() {\n    return pawnDirOf(piece.color);\n  }\n\n  function pawnDirOf(color) {\n    return color === 'white' ? _ => _.up(): _ => _.down();\n  }\n\n  function shortRange(dirs) {\n    return dirs.flatMap(_ => _(pos) || []).flatMap(to => {\n      let _ = board.move(pos, to);\n      if (_) {\n        return [move(to, _)];\n      } else {\n        return [];\n      }\n    });\n  }\n\n  function longRange(dirs) {\n    let res = [];\n\n    function addAll(p, dir) {\n      let to;\n      if ((to = dir(p))) {\n\n        let piece = board.pieces[to.key];\n\n        if (piece) {\n          if (piece.color !== color) {\n            let _ = board.taking(pos, to);\n            res.push(move(to, _, {\n              capture: to\n            }));\n          }\n        } else {\n          let _ = board.move(pos, to);\n          if (_) { \n            res.push(move(to, _));\n          }\n          addAll(to, dir);\n        }\n      }\n    }\n\n    dirs.forEach(_ => addAll(pos, _));\n\n    return res;\n  };\n\n\n  function move(dest,\n                after, extra) {\n\n    let capture,\n        promotion,\n        castle,\n        enpassant;\n\n    if (extra) {\n      capture = extra.capture;\n      castle = extra.castle;\n      promotion = extra.promotion;\n      enpassant = extra.enpassant;\n    }\n    \n    return new Move({\n      piece,\n      orig: pos,\n      dest,\n      situationBefore: new Situation(board, piece.color),\n      after,\n      capture,\n      castle,\n      promotion,\n      enpassant\n    });\n  }\n}\n","import { valid, invalid, toValid } from './valid';\nimport { objForeach } from './outil';\nimport { Pos } from './pos';\nimport Actor from './actor';\n\nexport function Std(\n  dest,\n  role,\n  capture,\n  file,\n  rank,\n  promotion,\n  san) {\n  \n  this.san = san;\n  this.dest = dest;\n  this.role = role;\n  this.capture = capture;\n  this.file = file;\n  this.rank = rank;\n  this.promotion = promotion;\n  \n\n  this.move = (situation) => {\n\n    let res = null;\n    objForeach(situation.board.pieces, (pos, piece) => {\n      if (res) {\n        return;\n      }\n      if (piece.color === situation.color &&\n          piece.role === role.roleString &&\n          compare(file, Pos.fromKey(pos).file.char) &&\n          compare(rank, Pos.fromKey(pos).rank.char)) {\n        let a = new Actor(piece, Pos.fromKey(pos), situation.board);\n        res = a.pseudoValidMoves().find(m => \n          m.dest.key === dest.key\n        );\n      }\n    });\n\n    if (!res) {\n      return invalid(`No move found: ${san}`);\n    }\n\n    return valid(res);\n  };\n\n  function compare(a, b) {\n    return !a || a === b;\n  }\n\n}\n\nexport function Castle(side, san) {\n  this.san = san;\n  this.side = side;\n\n\n  this.move = situation => {\n\n    let kingPos = toValid(situation.board.kingPosOf(situation.color), \"No king found\");\n\n    if (kingPos.invalid) {\n      return kingPos;\n    }\n\n    let actor = toValid(situation.board.actorAt(kingPos.value.key), \"No Actor found\");\n\n    if (actor.invalid) {\n      return actor;\n    }\n\n    let move = toValid(actor.value.castleOn(side)[0], \"Cannot castle\");\n\n    return move;\n  };\n\n}\n","import { valid, invalid } from './valid';\nimport { Castle, Std } from './san';\nimport { KingSide, QueenSide } from './side';\nimport { Pos, Role, Pawn } from './pos';\n\nexport function parseSan(san) {\n\n  const moveRegex = /^(N|B|R|Q|K|)([a-h]?)([1-8]?)(x?)([a-h][1-8])(=?[NBQR]?)(\\+?)(\\#?)$/;\n  \n  if (san === 'O-O' || san === 'o-o' || san === '0-0') {\n    return valid(new Castle(KingSide, san));\n  }\n  if (san === 'O-O-O' || san === 'o-o-o' || san === '0-0-0') {\n    return valid(new Castle(QueenSide, san));\n  }\n\n  let match = san.match(moveRegex);\n\n  if (!match) {\n    return invalid({ err: `Couldn't parse`,\n                     san });\n  }\n\n  let [_, role, file, rank, capture, pos, prom, check, mate] = match;\n\n  let dest = Pos.fromKey(pos);\n\n  if (pos) {\n    return valid(new Std(\n      dest,\n      Role.forsyth(role) || Pawn,\n      capture !== \"\",\n      file,\n      rank,\n      prom,\n      san\n    ));\n  }\n\n  return invalid({ err: `Invalid move`, \n                   san });\n}\n\nexport function parseLine(line) {\n  const blackMoveRegex = /^(\\d*)\\.\\.\\.$/;\n  const whiteMoveRegex = /^(\\d*)\\.$/;\n\n  let oneMove,\n      ply,\n      _moves = [];\n\n  line.split(' ').forEach(next => {\n    let match;\n    if ((match = next.match(blackMoveRegex))) {\n      ply = parseInt(match[0]) * 2;\n      oneMove = [null];\n    } else if ((match = next.match(whiteMoveRegex))) {\n      ply = parseInt(match[0]) * 2 - 1;\n      oneMove = [];\n    } else {\n\n      let move = parseSan(next).map(_ => ({\n        ply: ply++,\n        move: _\n      }));\n\n      oneMove.push(move);\n\n      if (oneMove.length === 2) {\n        _moves.push(oneMove);\n        oneMove = [];\n      }\n    }\n  });\n\n  if (oneMove.length === 1) {\n    _moves.push(oneMove);\n  }\n  \n  return _moves;\n}\n","export function renderLineModel(vLine, plyMove) {\n  return new RenderLineModel(vLine, plyMove);\n}\n\nfunction RenderLineModel(vLine, plyMove) {\n\n  vLine.fold(({ ply, move }) => {\n    this.ply = ply;\n    this.san = move.san;\n    this.plyStrWhite = (ply + 1) / 2 + '. ';\n    this.plyStrBlack = ply / 2 + '... ';\n\n\n    plyMove(ply).fold(_ => _,\n                 err => {\n                   this.err = err;\n                 });\n\n  }, ({ err, san }) => {\n    this.ply = 'E';\n    this.plyStrWhite = 'E. ';\n    this.plyStrBlack = 'E. ';\n\n    this.err = err;\n    this.san = san;\n  });\n  \n}\n","import { key2pos } from './util';\n\nexport function svg(name, children = []) {\n  let el = document.createElementNS('http://www.w3.org/2000/svg', name);\n\n  if (children.forEach) {\n    children.forEach(_ => el.appendChild(_));\n  }\n\n  return el;\n}\n\nexport function renderShape(shape, color, bounds) {\n  \n  // TODO orient\n  let orig = orient(key2pos(shape.orig), color);\n\n  let el;\n\n  if (shape.dest) {\n    let dest = orient(key2pos(shape.dest), color);\n\n    el = renderArrow(shape.brush,\n                     orig,\n                     dest,\n                     bounds);\n  } else {\n    el = renderCircle(shape.brush, orig, bounds);\n  }\n\n  return el;\n}\n\nfunction renderArrow(brush, orig, dest, bounds) {\n\n  const m = arrowMargin(bounds),\n        a = pos2px(orig, bounds),\n        b = pos2px(dest, bounds),\n        dx = b[0] - a[0],\n        dy = b[1] - a[1],\n        angle = Math.atan2(dy, dx),\n        xo = Math.cos(angle) * m,\n        yo = Math.sin(angle) * m;\n\n  return setAttributes(svg('line'), {\n    stroke: brush.color,\n    'stroke-width': lineWidth(brush, bounds),\n    'stroke-linecap': 'round',\n    'marker-end': 'url(#arrowhead-' + brush.key + ')',\n    opacity: brush.opacity,\n    x1: a[0],\n    y1: a[1],\n    x2: b[0] - xo,\n    y2: b[1] - yo\n  });\n}\n\nfunction renderCircle(brush, pos, bounds) {\n  \n  const o = pos2px(pos, bounds),\n        width = circleWidth(bounds),\n        radius = (bounds.width + bounds.height) / 32;\n\n  return setAttributes(svg('circle'), {\n    stroke: brush.color,\n    'stroke-width': width,\n    fill: 'none',\n    opacity: brush.opacity,\n    cx: o[0],\n    cy: o[1],\n    r: radius - width / 2    \n  });  \n}\n\nfunction lineWidth(brush, bounds) {\n  return (brush.lineWidth || 10) / 512 * bounds.width;\n}\n\nfunction arrowMargin(bounds) {\n  return 10 / 512 * bounds.width;\n}\n\nfunction circleWidth(bounds) {\n  return 4 * (bounds.width / 512);\n}\n\nfunction pos2px(pos, bounds) {\n  return [(pos[0] + 0.5) * bounds.width / 8,\n          (7.5 - pos[1]) * bounds.height / 8];\n}\n\nfunction orient(pos, color) {\n  return color === 'white' ? pos : [7 - pos[0], 7 - pos[1]];\n}\n\n\nexport function renderMarker(brush) {\n  \n  const marker = setAttributes(svg('marker'), {\n    id: 'arrowhead-' + brush.key,\n    orient: 'auto',\n    markerWidth: 4,\n    markerHeight: 8,\n    refX: 2.05,\n    refY: 2.01\n  });\n\n  marker.appendChild(setAttributes(svg('path'), {\n    d: 'M0,0 V4 L3,2 Z',\n    fill: brush.color\n  }));\n\n  marker.setAttribute('mdKey', brush.key);\n\n  return marker;\n}\n\nfunction setAttributes(el, attrs) {\n  for (const key in attrs) el.setAttribute(key, attrs[key]);\n  return el;\n}\n","import { brush } from './brush';\nimport * as util from './util';\nimport * as dom from './dom';\nimport * as SVG from './svg';\n\nlet { ranks,\n      files,\n      key2pos,\n      fPosToTranslateAbs } = util;\n\nlet { svg, renderMarker, renderShape } = SVG;\n\nlet { div, tag, fAttribute, fTranslateAbs, fListen, updateChildren } = dom;\n\nexport function renderLine(line, fHover, fOut) {\n  let onHover = ply => {\n    return _ => {\n      ['touchstart', 'mouseover'].forEach(event =>\n        fListen(event, el => fHover(ply, el))(_)\n      );\n      ['touchend', 'mouseout'].forEach(event =>\n        fListen(event, fOut)(_));\n    };\n  };\n\n  return line.flatMap(([mwhite, mblack]) => {\n    let onHoverWhite = mwhite && onHover(mwhite.ply),\n        onHoverBlack = mblack && onHover(mblack.ply);\n\n    let fAttributeWhite = mwhite && fAttribute({ title: mwhite.err, 'data-err': mwhite.err });\n    let fAttributeBlack = mblack && fAttribute({ title: mblack.err, 'data-err': mblack.err });\n\n    return mwhite && mblack ?\n      [\n        tag('strong.moven', mwhite.plyStrWhite),\n        tag('span.movem', mwhite.san + ' ', [fAttributeWhite,\n                                             onHoverWhite]),\n        tag('span.movem', mblack.san + ' ', [fAttributeBlack,\n                                             onHoverBlack]),\n      ]\n      : mwhite ? [\n        tag('strong.moven', mwhite.plyStrWhite),\n        tag('span.movem', mwhite.san + ' ', [fAttributeWhite,\n                                             onHoverWhite])\n      ] : [\n        tag('strong.moven', mblack.plyStrBlack),\n        tag('span.movem', mblack.san + ' ', [fAttributeBlack,\n                                             onHoverBlack]),\n      ];\n  });\n\n}\n\nexport function renderFen(color, pieces, shapes, bounds, lastMove) {\n\n  let asWhite = util.asWhite(color);\n  let fPosToTranslate = fPosToTranslateAbs(bounds);\n\n  let board = tag('md-board', [\n    ...lastMove.map(key => {\n      let pos = key2pos(key);\n      let move = tag(`square.last-move`, [],\n                     fTranslateAbs(fPosToTranslate(pos, asWhite)));\n      move.mdKey = key;\n      return move;\n    }),\n    ...Object.keys(pieces).map(key => {\n      let pos = key2pos(key);\n      let _ = pieces[key];\n      let piece = tag(`piece.${_.color}.${_.role}`, [],\n                      fTranslateAbs(fPosToTranslate(pos, asWhite)));\n\n      piece.mdKey = key;\n      \n      return piece;\n    })\n  ]);\n\n  let _svg = svg('svg', [\n    svg('defs', [\n      renderMarker(brush)\n    ]),\n    ...shapes.map(_ => renderShape(_, color, bounds))\n  ]);\n\n  let wrapper = tag('md-wrap', [\n    board,\n    _svg,\n    tag('coords.ranks.' + color, ranks.map(_ =>\n      tag('coord', _)\n    )),\n    tag('coords.files.' + color, files.map(_ =>\n      tag('coord', _)\n    )),\n  ]);\n\n  return {\n    wrapper,\n    board,\n    svg: _svg\n  };\n}\n\nexport function updateSvg(els, shapes, color) {\n\n  let { board, svg } = els;\n  let bounds = board.getBoundingClientRect();\n\n  let el = svg.firstChild;\n  let toRemove = [];\n\n  el = el.nextSibling;\n  while (el) {\n    toRemove.push(el);\n    el = el.nextSibling;\n  };\n\n  for (const el of toRemove) svg.removeChild(el);\n\n  \n  shapes.forEach(_ => {\n    svg.appendChild(renderShape(_, color, bounds));\n  });\n}\n\nexport function updateBounds(asWhite, elBoard) {\n  let bounds = elBoard.getBoundingClientRect();\n  let fPosToTranslate = fPosToTranslateAbs(bounds);\n  updateChildren(elBoard, _ => {\n    fTranslateAbs(fPosToTranslate(key2pos(_.mdKey), asWhite))(_);\n  });\n\n}\n","import { objFilter, objForeach, objMap, groupToMap } from './outil';\nimport { valid, invalid } from './valid';\nimport * as util from './util';\nimport { parseLine } from './parser';\nimport Situation from './situation';\nimport { renderLineModel } from './rendermodel';\nimport { renderLine, renderFen, updateBounds, updateSvg } from './render';\nimport { fTranslateAbs, fAddClass, fHide, fShow, div } from './dom';\n\nimport { parseMdFull, updatePreview } from './md';\n\nfunction isInViewport(bounds) {\n  return bounds.top >= 0 &&\n    bounds.left >= 0 &&\n    bounds.bottom <= window.innerHeight &&\n    bounds.right <= window.innerWidth;\n}\n\nfunction listenEndScroll(onEndScroll) {\n  let isScrolling;\n  document.addEventListener('scroll', function(event) {\n    clearTimeout(isScrolling);\n    isScrolling = setTimeout(onEndScroll, 60);\n  }, false);\n}\n\nfunction listenResize(element, fResize) {\n  const observer = new window.ResizeObserver(fResize);\n  observer.observe(element);\n  return () => {\n    observer.unobserve(element);\n  };\n}\n\nexport function Ply(play, ctx, el) {\n\n  let { history } = play;\n\n  let game,\n      color,\n      shapes,\n      ply,\n      pieces,\n      lastMove,\n      move,\n      bounds,\n      error;\n\n  this.el = el;\n  this.bounds = () => bounds;\n\n  this.init = (data) => {\n    game = data.game || 'main';\n    color = data.color;\n    shapes = util.readShapes(data.shapes);\n    ply = parseInt(data.ply);\n    pieces = {};\n    lastMove = [];\n\n    move = history.moveFor(game, ply);\n\n    if (move) {\n      move.value.fold(_ => {\n        let situation = _.situationAfter();\n        pieces = situation.board.pieces;\n        lastMove.push(_.orig.key);\n        lastMove.push(_.dest.key);\n      }, _ => {\n        error = _;\n      });\n    } else {\n      error = `No move found ${game}:${ply}`;\n    }\n\n    color = color || history.colorFor(game);\n\n    bounds = el.getBoundingClientRect();\n  };\n\n  let els;\n\n  this.syncVisible = () => {\n    bounds = el.getBoundingClientRect();\n    this.isInViewport = isInViewport(bounds);\n  };\n\n  let unlisten;\n  this.render = () => {\n    if (!unlisten) {\n    } else {\n      unlisten();\n\n      el.removeChild(els.wrapper);\n    }\n    this.wrap();\n  };\n\n\n  this.wrap = () => {\n\n    els = renderFen(color, pieces, shapes, bounds, lastMove);\n\n    el.appendChild(els.wrapper);\n\n    unlisten = listenResize(el, () => {\n      updateBounds(util.asWhite(color), els.board);\n      updateSvg(els, shapes, color);\n    });\n  };\n};\n\nexport function MoveLine(play, ctx, el) {\n\n  let sGame = el.dataset.game || 'main initial';\n  let sLine = el.dataset.line;\n  let sColor = el.dataset.color;\n\n  let _game = sGame.split(' ');\n  if (_game.length === 1) {\n    _game.push('main');\n  }\n  this.game = _game[0];\n  this.base = _game[1];\n  this.color = sColor;\n\n  let line = parseLine(sLine);\n  this.flat = line.flat()\n    .flatMap(_ => _ ? _.copyMap(_ => [_])\n             .getOrElse(_ => []): \n             []);\n\n  let fHover = (ply, el) => {\n    play.show(this.game, ply, el);\n  };\n\n  let fOut = () => {\n    play.hide();\n  };\n\n  this.wrap = () => {\n\n    const plyMove = (ply) => {\n      let move = play.history.moveFor(this.game, ply);\n      if (!move) {\n        return invalid(`No move for ${this.game}`);\n      }\n      return move.value;\n    };\n\n    let depth = play.history.lineDepthFor(this.game);\n\n    let fStyle = fAddClass(`depth${depth}`);\n\n    let lineModel = line.map(([mw, mb]) =>\n      [mw && renderLineModel(mw, plyMove),\n       mb && renderLineModel(mb, plyMove)]\n    );\n\n    let children = renderLine(lineModel, fHover, fOut);\n\n    children.forEach(_ => el.appendChild(_));\n    fStyle(el);\n  };\n\n};\n\nexport function History(play, ctx) {\n\n  let { lines } = play;\n\n  let linesByGame = groupToMap(lines, line => {\n    return { [line.game]: line };\n  });\n\n  let allGames = Object.keys(linesByGame);\n\n  let movesByGame = {};\n  let lineDepthByGame = {};\n  let colorByGame = {};\n\n  function findColors() {\n    allGames.forEach(game => {\n      colorByGame[game] = findColorByGameHelper(game);\n    });\n  }\n\n  findColors();\n\n  function findColorByGameHelper(game) {\n\n    if (game === 'initial' || !linesByGame[game]) {\n      return 'white';\n    }\n\n    let line = linesByGame[game][0];\n\n    return line.color || findColorByGameHelper(line.base);\n  }\n\n  function playVariations() {\n    function step(curr, depth, color) {\n      objForeach(playVariationsHelper(curr), (_, v) => {\n        movesByGame[_] = v;\n        lineDepthByGame[_] = depth;\n        step(_, depth + 1);\n      });\n    }\n    step('initial', 0, 'white');\n  }\n\n  playVariations();\n\n  function playVariationsHelper(base) {\n    let variationLines = objFilter(linesByGame, (_, lines) => \n      lines[0].base === base);\n\n    let variationMoves = objMap(variationLines, (_, lines) => ({\n      [_]: lines.flatMap(_ => _.flat)\n        .sort((a, b) => a.ply < b.ply ? -1 : a.ply === b.ply ? 0 : 1)\n    }));\n\n    return objMap(variationMoves, (_, moves) => {\n      let situation = situationFor(base, moves[0].ply - 1);\n      return { [_]:  playMoves(moves, situation) };\n    });\n  }\n\n  this.lineDepthFor = (base) => {\n    return lineDepthByGame[base];\n  };\n\n  this.colorFor = (base) => {\n    return colorByGame[base];\n  };\n\n  this.situationFor = situationFor;\n  this.moveFor = moveFor;\n\n  function moveFor(base, ply) {\n    if (!movesByGame[base]) {\n      console.warn(`No variation found for ${base}`);\n      return null;\n    }\n\n    let oMove = movesByGame[base]\n        .find(_ => _.ply === ply);\n\n    if (!oMove) {\n      console.warn(`No move found for ${base} ${ply}`);\n      return null;\n    }\n    return oMove;\n  }\n\n  function situationFor(base, ply) {\n    if (ply === 0) {\n      return Situation.apply();\n    }\n\n    let move = moveFor(base, ply);\n\n    if (move) {\n      return move.value.map(_ =>\n        _.situationAfter()\n      ).getOrElse(Situation.apply);\n    } else {\n      return Situation.apply();\n    }\n  }\n\n  function playMoves(moves, situation) {\n    return moves.map(({ ply, move }) => {\n\n      let value = situation ? move.move(situation).flatMap(_ => {\n        situation = _.situationAfter();\n        return valid(_);\n      }, _ => {\n        situation = null;\n        return invalid(_);\n      }) : invalid('No situation.');\n\n      return {\n        ply,\n        value\n      };\n    });\n  };\n  \n}\n\nexport const makePlys = (play, ctx) => {\n  let { element } = ctx;\n\n  let res = [];\n  for (let _ of element.querySelectorAll('[data-ply]')) {\n    let ply = new Ply(play, ctx, _);\n    ply.init({\n      game: _.dataset.game,\n      color: _.dataset.color,\n      shapes: _.dataset.shapes,\n      ply: _.dataset.ply\n    });\n    res.push(ply);\n  }\n  return res;\n};\n\nexport const makeMoveLines = (play, ctx) => {\n  let { element } = ctx;\n  let res = [];\n  for (let _ of element.querySelectorAll('[data-line]')) {\n    res.push(new MoveLine(play, ctx, _));\n  }\n  return res;\n};\n\nexport function Play(ctx) {\n\n  let { element } = ctx;\n\n  let lines = this.lines = makeMoveLines(this, ctx);\n  let history = this.history = new History(this, ctx);\n  let plys = this.plys = makePlys(this, ctx);\n\n  let hoverEl = div('.hover-ply', [], fHide);\n  let hoverPly = new Ply(this, ctx, hoverEl);\n\n  this.wrap = () => {\n\n    element.appendChild(hoverEl);\n    \n    lines.forEach(_ => _.wrap());\n    plys.forEach(_ => _.wrap());\n  };\n\n  let visiblePly = this.visiblePly = () => {\n    return plys.filter(_ => _.isInViewport)[0];\n  };\n\n  function findVisiblePly() {\n    plys.forEach(_ => _.syncVisible());\n  }\n\n  this.listen = () => {\n    listenEndScroll(findVisiblePly);\n    findVisiblePly();\n  };\n\n  this.hide = () => {\n    fHide(hoverEl);\n  };\n\n  this.show = (game, ply, elN) => {\n\n    let vp = visiblePly();\n    let posToTranslate = [window.pageXOffset, window.pageYOffset];\n    if (vp) {\n      posToTranslate[0] += vp.bounds().left;\n      posToTranslate[1] += vp.bounds().top;\n    } else {\n      let { clientWidth } = ctx.element;\n      let offBounds = elN.getBoundingClientRect();\n      let helBounds = hoverEl.getBoundingClientRect();\n\n      if (offBounds.left < clientWidth / 2) {\n        posToTranslate[0] += clientWidth - helBounds.width - 4;\n      }\n\n    }\n\n    fTranslateAbs(posToTranslate)(hoverEl);\n    \n    hoverPly.init({\n      game,\n      ply\n    });\n    hoverPly.render();\n    fShow(hoverEl);\n  };\n}\n\nexport function app(element, options) {\n  \n  let ctx = {\n    element\n  };\n\n  if (options.content) {\n    let model = parseMdFull(options.content);\n    updatePreview(model, element);\n   }\n\n\n  let play = new Play(ctx);\n\n  play.wrap();\n  play.listen();\n\n}\n"],"sourceRoot":""}